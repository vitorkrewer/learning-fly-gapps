<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
      body { padding: 20px; background-color: #f8f9fa; }
      .step { display: none; }
      .step.active { display: block; }
      #loader {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .table-container {
        max-height: 300px;
        overflow-y: auto;
      }
      .btn-primary, .btn-success { background-color: #4285f4; border-color: #4285f4; }
      .btn-primary:hover, .btn-success:hover { background-color: #357ae8; border-color: #357ae8; }
      .card-header { background-color: #4285f4; color: white; }
    </style>
</head>
<body>
    <div id="loader" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <p class="mt-2" id="loader-text">Processando...</p>
    </div>

    <div class="container">
      <h3 class="mb-4 text-center">Emissor de Certificados</h3>

      <div id="step1" class="step active">
        <div class="card">
          <div class="card-header">Etapa 1: Configuração da Emissão</div>
          <div class="card-body">
            <form id="configForm">
              
              <div class="form-group">
                <label for="parceiroSelect">Selecione o Parceiro</label>
                <select class="form-control" id="parceiroSelect" required>
                  <option value="" disabled selected>Carregando parceiros...</option>
                </select>
              </div>
              <input type="hidden" id="idParceiro">
              <input type="hidden" id="nomeParceiro">

              <div class="form-group">
                <label for="NomeCertificado">Nome do Certificado (para controle interno)</label>
                <input type="text" class="form-control" id="NomeCertificado" required>
              </div>
              <div class="form-group">
                <label for="NomeEvento">Nome do Evento</label>
                <input type="text" class="form-control" id="NomeEvento" required>
              </div>
              
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="DataEvento">Data do Evento</label>
                  <input type="date" class="form-control" id="DataEvento" required>
                </div>
                <div class="form-group col-md-6">
                  <label for="DataEmissao">Data de Emissão (do certificado)</label>
                  <input type="date" class="form-control" id="DataEmissao" required>
                </div>
              </div>

               <div class="form-group">
                <label for="MensagemCorpo">Mensagem do Corpo do Certificado</label>
                <textarea class="form-control" id="MensagemCorpo" rows="3" placeholder="Ex: por ter participado ativamente das atividades..."></textarea>
              </div>
              <hr>
              <div class="form-group">
                <label for="idSheetParticipantes">ID da Planilha de Participantes</label>
                <input type="text" class="form-control" id="idSheetParticipantes" required placeholder="Cole o ID da planilha aqui...">
              </div>
              <div class="form-group">
                <label for="TemplateDocID">ID do Documento Modelo (Template)</label>
                <input type="text" class="form-control" id="TemplateDocID" required placeholder="Cole o ID do Google Doc aqui...">
              </div>
               <div class="form-group">
                <label for="TargetFolderID">ID da Pasta no Google Drive para Salvar os PDFs</label>
                <input type="text" class="form-control" id="TargetFolderID" required placeholder="Cole o ID da pasta do Drive aqui...">
              </div>

              <button type="submit" class="btn btn-primary btn-block">Salvar e Avançar para Revisão</button>
            </form>
          </div>
        </div>
      </div>

      <div id="step2" class="step">
         <div class="card">
          <div class="card-header">Etapa 2: Revisão e Emissão</div>
          <div class="card-body">
            <p>Os seguintes participantes foram encontrados. Verifique os dados antes de emitir.</p>
            <div id="participants-table-container" class="table-container">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>Nome do Participante</th>
                    <th>Email</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="participants-tbody">
                  </tbody>
              </table>
            </div>
            <div class="mt-3">
              <button id="emitirBtn" class="btn btn-success btn-block">Emitir Certificados</button>
              <button id="voltarBtn" class="btn btn-secondary btn-block mt-2">Voltar</button>
            </div>
          </div>
        </div>
      </div>

      <div id="step3" class="step">
        <div class="card">
           <div class="card-header">Processo Concluído</div>
           <div class="card-body text-center">
             <div id="result-message"></div>
             <button onclick="google.script.host.close()" class="btn btn-primary mt-4">Fechar</button>
           </div>
        </div>
      </div>

    </div>

    <script>
      let savedConfig = {};
      let participantsData = [];
      let currentConfigId = '';
      
      window.addEventListener('load', carregarParceiros);

      function carregarParceiros() {
        google.script.run
          .withSuccessHandler(onParceirosCarregados)
          .withFailureHandler(onFailure)
          .buscarParceiros();
      }

      function onParceirosCarregados(response) {
        const result = JSON.parse(response);
        const select = document.getElementById('parceiroSelect');
        if (result.success && result.data.length > 0) {
          select.innerHTML = '<option value="" disabled selected>Selecione um parceiro</option>';
          result.data.forEach(parceiro => {
            const option = document.createElement('option');
            option.value = parceiro.id;
            option.textContent = parceiro.nome;
            option.dataset.nome = parceiro.nome;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="" disabled selected>Nenhum parceiro cadastrado</option>';
          if(!result.success) onFailure(result);
        }
      }

      document.getElementById('parceiroSelect').addEventListener('change', function(e) {
          const selectedOption = e.target.options[e.target.selectedIndex];
          document.getElementById('idParceiro').value = selectedOption.value;
          document.getElementById('nomeParceiro').value = selectedOption.dataset.nome;
      });

      document.getElementById('configForm').addEventListener('submit', function(e) {
        e.preventDefault();
        showLoader('Salvando configuração...');
        
        // ALTERAÇÃO AQUI: Captura o novo campo DataEmissao
        savedConfig = {
          idParceiro: document.getElementById('idParceiro').value,
          nomeParceiro: document.getElementById('nomeParceiro').value,
          NomeCertificado: document.getElementById('NomeCertificado').value,
          NomeEvento: document.getElementById('NomeEvento').value,
          DataEvento: document.getElementById('DataEvento').value,
          DataEmissao: document.getElementById('DataEmissao').value, // NOVO CAMPO
          MensagemCorpo: document.getElementById('MensagemCorpo').value,
          idSheetParticipantes: document.getElementById('idSheetParticipantes').value,
          TemplateDocID: document.getElementById('TemplateDocID').value,
          TargetFolderID: document.getElementById('TargetFolderID').value,
        };

        google.script.run
          .withSuccessHandler(onConfigSaved)
          .withFailureHandler(onFailure)
          .salvarConfiguracao(savedConfig);
      });

      function onConfigSaved(response) {
        const result = JSON.parse(response);
        if (result.success) {
          currentConfigId = result.configId;
          showLoader('Buscando participantes...');
          google.script.run
            .withSuccessHandler(onParticipantsFound)
            .withFailureHandler(onFailure)
            .buscarParticipantes(result.idSheetParticipantes);
        } else {
          onFailure(result);
        }
      }

      function onParticipantsFound(response) {
        hideLoader();
        const result = JSON.parse(response);
        if (result.success) {
          participantsData = result.data;
          const tbody = document.getElementById('participants-tbody');
          tbody.innerHTML = ''; 
          if (participantsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum participante encontrado.</td></tr>';
          } else {
             participantsData.forEach(p => {
              const row = `<tr>
                            <td>${p.NomeParticipante || 'N/A'}</td>
                            <td>${p.EmailParticipante || 'N/A'}</td>
                            <td>${p.StatusEmissao || 'Pendente'}</td>
                          </tr>`;
              tbody.innerHTML += row;
            });
          }
          changeStep('step2');
        } else {
          onFailure(result);
        }
      }
      
      document.getElementById('emitirBtn').addEventListener('click', function() {
        showLoader('Emitindo certificados... Isso pode levar alguns minutos.');
        const emissaoData = {
          config: savedConfig,
          participantes: participantsData,
          templateId: savedConfig.TemplateDocID,
          folderId: savedConfig.TargetFolderID,
          configId: currentConfigId
        };
        google.script.run
          .withSuccessHandler(onEmissionComplete)
          .withFailureHandler(onFailure)
          .emitirCertificados(emissaoData);
      });

      function onEmissionComplete(response) {
        hideLoader();
        const result = JSON.parse(response);
        let messageHtml = `<h4>${result.message}</h4>`;
        if (result.details && result.details.length > 0) {
          messageHtml += '<div class="alert alert-danger mt-3 text-left"><p>Detalhes dos erros:</p><ul>';
          result.details.forEach(det => {
            messageHtml += `<li>${det}</li>`;
          });
          messageHtml += '</ul></div>';
        }
        document.getElementById('result-message').innerHTML = messageHtml;
        changeStep('step3');
      }


      document.getElementById('voltarBtn').addEventListener('click', function() {
        changeStep('step1');
      });

      function onFailure(error) {
        hideLoader();
        alert('Ocorreu um erro: ' + (error.message || 'Erro desconhecido. Verifique os logs.'));
      }

      function showLoader(text) {
        document.getElementById('loader-text').innerText = text;
        document.getElementById('loader').style.display = 'flex';
      }

      function hideLoader() {
        document.getElementById('loader').style.display = 'none';
      }

      function changeStep(stepId) {
        document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
        document.getElementById(stepId).classList.add('active');
      }
    </script>
</body>
</html>